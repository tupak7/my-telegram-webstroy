<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MELBET</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    @keyframes winFlash { 
      0% { background-color:#22c55e33 } 
      50% { background-color:#22c55e66 } 
      100% { background-color:transparent } 
    }
    @keyframes loseFlash { 
      0% { background-color:#ef444433 } 
      50% { background-color:#ef444466 } 
      100% { background-color:transparent } 
    }
    .animate-win { animation: winFlash 0.6s ease; }
    .animate-lose { animation: loseFlash 0.6s ease; }

    /* –ö–Ω–æ–ø–∫–∏ –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      width: 100%;
    }

    .btn-group > button {
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 70px;
      white-space: nowrap;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 0.25rem 0.5rem;
      transition: background 0.2s;
    }

    .btn-group > button:hover {
      background-color: #f3f4f6;
    }

    @media (max-width: 640px) {
      .btn-group {
        flex-direction: column;
      }
      .btn-group > button {
        width: 100%;
      }
    }

    img {
      width: 70px;
      height: 70px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ */
    .action-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .action-btn:active {
      transform: translateY(0);
    }
  </style>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div id="root" class="w-full max-w-3xl"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [amount, setAmount] = useState(1);
      const [percent, setPercent] = useState(50);
      const [balance, setBalance] = useState(1000);
      const [lastGames, setLastGames] = useState([]);
      const [hash, setHash] = useState('');
      const [animClass, setAnimClass] = useState('');
      const [tg, setTg] = useState(null);
      const [user, setUser] = useState(null);
      const MAX_PERCENT = 90;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
      useEffect(() => {
        const telegram = window.Telegram?.WebApp;
        if (telegram) {
          telegram.ready();
          setTg(telegram);
          setUser(telegram.initDataUnsafe?.user);
          
          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
          telegram.MainButton.setText('–ü–û–ü–û–õ–ù–ò–¢–¨');
          telegram.MainButton.onClick(() => {
            telegram.showPopup({
              title: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
              message: '–§—É–Ω–∫—Ü–∏—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞!',
              buttons: [{ type: 'close' }]
            });
          });
        }
      }, []);

      useEffect(() => { setHash(generateHash()); }, []);

      function generateHash() {
        const r = Math.random().toString(36).slice(2) + Date.now().toString(36);
        let s = 0;
        for (let i = 0; i < r.length; i++) { s = (s << 5) - s + r.charCodeAt(i); s |= 0; }
        return Math.abs(s).toString(16).padStart(32, '0');
      }

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
      const handleWithdraw = () => {
        if (tg) {
          tg.showPopup({
            title: 'üí∞ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤',
            message: '–§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞!\n\n–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 100 RUB\n–ö–æ–º–∏—Å—Å–∏—è: 0%',
            buttons: [{ type: 'close' }]
          });
        } else {
          alert('üí∞ –§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞!\n–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 100 RUB');
        }
      };

      const handleProfile = () => {
        if (tg && user) {
          const userInfo = `üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\nID: ${user.id}\n–ò–º—è: ${user.first_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n–§–∞–º–∏–ª–∏—è: ${user.last_name || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}\nUsername: @${user.username || '–ù–µ —É–∫–∞–∑–∞–Ω'}\n\n–ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} RUB\n–í—Å–µ–≥–æ –∏–≥—Ä: ${lastGames.length}`;
          
          tg.showPopup({
            title: 'üë§ –ü—Ä–æ—Ñ–∏–ª—å',
            message: userInfo,
            buttons: [{ type: 'close' }]
          });
        } else {
          alert(`üë§ –ü—Ä–æ—Ñ–∏–ª—å:\n\n–ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} RUB\n–í—Å–µ–≥–æ –∏–≥—Ä: ${lastGames.length}\n\n–î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram –±–æ—Ç–µ`);
        }
      };

      function calcPossibleWin() {
        const odds = Math.max(1, Math.min(MAX_PERCENT, percent)) / 100;
        const win = +(amount * (1 / odds)).toFixed(2);
        return isFinite(win) ? win : 0;
      }

      function addLastGame(entry) {
        setLastGames(prev => [entry, ...prev].slice(0, 20));
      }

      function play(isHigher) {
        if (balance < amount) return;
        const num = Math.floor(Math.random() * 1_000_000);
        const chance = Math.min(Math.max(Math.floor(percent), 1), MAX_PERCENT);
        const roll = num % 100;
        const isWin = isHigher ? (roll > (100 - chance)) : (roll < chance);
        const wonAmount = isWin ? +(calcPossibleWin()).toFixed(2) : 0;
        const newBalance = +(balance - amount + wonAmount).toFixed(2);
        const safeBalance = Math.max(0, newBalance);
        setBalance(safeBalance);

        const entry = {
          id: Date.now(),
          number: String(num).padStart(6, '0'),
          side: isHigher ? '–ë–æ–ª—å—à–µ' : '–ú–µ–Ω—å—à–µ',
          amount: +amount,
          chance: `${chance}%`,
          win: +wonAmount,
          success: isWin
        };

        addLastGame(entry);
        setHash(generateHash());
        setAnimClass(isWin ? 'animate-win' : 'animate-lose');
        setTimeout(() => setAnimClass(''), 600);
      }

      function handleAmountChange(v) {
        setAmount(prev => {
          const next = typeof v === 'function' ? v(prev) : v;
          return Math.max(0.01, +next);
        });
      }

      function handlePercentChange(v) {
        setPercent(prev => {
          const next = typeof v === 'function' ? v(prev) : v;
          return Math.min(MAX_PERCENT, Math.max(1, Math.round(next)));
        });
      }

      return (
        <div className={"bg-white p-6 rounded-2xl shadow-md w-full transition " + animClass}>
          <header className="flex items-center justify-between mb-6">
            <img src="glavstroy.png" alt="–ª–æ–≥–æ—Ç–∏–ø" />
            <h1 className="text-2xl font-bold text-blue-700">MELBET</h1>                      
            <div className="flex items-center gap-3">
              <span className="text-gray-600 text-sm">–ë–∞–ª–∞–Ω—Å</span>
              <div className="bg-gray-100 px-3 py-1 rounded font-semibold">{balance.toFixed(2)}</div>
            </div>
          </header>

          {/* –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –í—ã–≤–µ—Å—Ç–∏ –∏ –ü—Ä–æ—Ñ–∏–ª—å */}
          <div className="flex gap-3 mb-6">
            <button
              onClick={handleWithdraw}
              className="action-btn bg-gradient-to-r from-green-500 to-emerald-600 text-white"
            >
              üí∞ –í—ã–≤–µ—Å—Ç–∏
            </button>
            <button
              onClick={handleProfile}
              className="action-btn bg-gradient-to-r from-blue-500 to-purple-600 text-white"
            >
              üë§ –ü—Ä–æ—Ñ–∏–ª—å
            </button>
          </div>

          <div className="grid grid-cols-12 gap-6 items-start">
            {/* –°—Ç–∞–≤–∫–∞ */}
            <div className="col-span-12 sm:col-span-4">
              <label className="block text-sm text-gray-600 mb-1">–°—É–º–º–∞</label>
              <input
                type="number"
                className="w-full border rounded px-3 py-2"
                value={amount}
                step="0.01"
                min="0.01"
                onChange={(e) => setAmount(Number(e.target.value) || 0.01)}
              />
              <div className="mt-2 btn-group">
                <button onClick={() => handleAmountChange(a => +(a * 2).toFixed(2))}>–£–¥–≤–æ–∏—Ç—å</button>
                <button onClick={() => handleAmountChange(a => +(a / 2).toFixed(2))}>–ü–æ–ª–æ–≤–∏–Ω–∞</button>
                <button onClick={() => setAmount(1)}>–ú–∏–Ω</button>
                <button onClick={() => setAmount(Math.max(0.01, balance))}>–ú–∞–∫—Å</button>
              </div>
            </div>

            {/* –ü—Ä–æ—Ü–µ–Ω—Ç */}
            <div className="col-span-12 sm:col-span-4">
              <label className="block text-sm text-gray-600 mb-1">–ü—Ä–æ—Ü–µ–Ω—Ç (—à–∞–Ω—Å, –º–∞–∫—Å {MAX_PERCENT}%)</label>
              <input
                type="number"
                className="w-full border rounded px-3 py-2"
                value={percent}
                min="1"
                max={MAX_PERCENT}
                onChange={(e) => setPercent(Math.min(MAX_PERCENT, Number(e.target.value) || 1))}
              />
              <div className="mt-2 btn-group">
                <button onClick={() => handlePercentChange(p => Math.max(1, Math.round(p / 2)))}>–ü–æ–ª–æ–≤–∏–Ω–∞</button>
                <button onClick={() => handlePercentChange(p => Math.min(MAX_PERCENT, p * 2))}>–£–¥–≤–æ–∏—Ç—å</button>
                <button onClick={() => setPercent(1)}>–ú–∏–Ω</button>
                <button onClick={() => setPercent(MAX_PERCENT)}>–ú–∞–∫—Å</button>
              </div>
            </div>

            {/* –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ */}
            <div className="col-span-12 sm:col-span-4 text-center">
              <div className="text-3xl font-semibold text-blue-600">{calcPossibleWin().toFixed(2)}</div>
              <div className="text-sm text-gray-500 mb-3">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à</div>

              <div className="flex gap-3 justify-center mt-4">
                <button
                  onClick={() => play(false)}
                  disabled={balance < amount}
                  className={`px-6 py-2 rounded ${balance < amount ? 'bg-gray-300' : 'bg-gray-600 text-white hover:bg-gray-700'}`}
                >
                  –ú–µ–Ω—å—à–µ
                </button>
                <button
                  onClick={() => play(true)}
                  disabled={balance < amount}
                  className={`px-6 py-2 rounded ${balance < amount ? 'bg-gray-300' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                >
                  –ë–æ–ª—å—à–µ
                </button>
              </div>
            </div>
          </div>

          <div className="mt-6 text-sm text-gray-500">
            <div className="mb-2">
              Hash –∏–≥—Ä—ã: <code className="break-all bg-gray-50 px-2 py-1 rounded">{hash}</code>
            </div>
          </div>

          <div className="mt-6">
            <h3 className="text-lg font-semibold mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</h3>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-xs text-gray-500">
                    <th className="py-2">–õ–æ–≥–∏–Ω</th>
                    <th className="py-2">–ß–∏—Å–ª–æ</th>
                    <th className="py-2">–¶–µ–ª—å</th>
                    <th className="py-2">–°—É–º–º–∞</th>
                    <th className="py-2">–®–∞–Ω—Å</th>
                    <th className="py-2">–í—ã–∏–≥—Ä—ã—à</th>
                  </tr>
                </thead>
                <tbody>
                  {lastGames.length === 0 && (
                    <tr><td colSpan={6} className="py-6 text-center text-gray-400">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</td></tr>
                  )}
                  {lastGames.map(g => (
                    <tr key={g.id} className="border-t">
                      <td className="py-3">You</td>
                      <td className={`py-3 ${g.success ? 'text-green-600' : 'text-red-600'}`}>{g.number}</td>
                      <td className="py-3">{g.side}</td>
                      <td className="py-3">{g.amount.toFixed(2)}</td>
                      <td className="py-3">{g.chance}</td>
                      <td className="py-3 font-semibold">{g.win.toFixed(2)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
