<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MELBET</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @keyframes winFlash {0%{background-color:#22c55e33}50%{background-color:#22c55e66}100%{background-color:transparent}}
    @keyframes loseFlash {0%{background-color:#ef444433}50%{background-color:#ef444466}100%{background-color:transparent}}
    .animate-win {animation:winFlash .6s ease}
    .animate-lose {animation:loseFlash .6s ease}
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div id="root" class="w-full max-w-3xl"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const tg = window.Telegram?.WebApp;

    function App() {
      const [amount, setAmount] = useState(1);
      const [percent, setPercent] = useState(50);
      const [balance, setBalance] = useState(null);
      const [lastGames, setLastGames] = useState([]);
      const [hash, setHash] = useState("");
      const [animClass, setAnimClass] = useState("");
      const MAX_PERCENT = 90;
      const API_URL = "https://dfdb3c09-5d33-48ef-bee1-f90e7be06ae8-00-xcaxgzrezs81.janeway.replit.dev"; // NEW URL


      useEffect(() => {
        if (tg && tg.initDataUnsafe?.user) {
          const userId = tg.initDataUnsafe.user.id;
          fetch(`${API_URL}/api/user/${userId}`)
            .then((res) => res.json())
            .then((data) => setBalance(data.balance))
            .catch(() => setBalance(0));
        } else {
          setBalance(1000);
        }
        setHash(generateHash());
      }, []);

      function generateHash() {
        const r = Math.random().toString(36).slice(2) + Date.now().toString(36);
        let s = 0;
        for (let i = 0; i < r.length; i++) s = (s << 5) - s + r.charCodeAt(i);
        return Math.abs(s).toString(16).padStart(32, "0");
      }

      function calcPossibleWin() {
        const odds = Math.max(1, Math.min(MAX_PERCENT, percent)) / 100;
        return +(amount * (1 / odds)).toFixed(2);
      }

      function play(isHigher) {
        if (balance === null || balance < amount) return;
        const roll = Math.floor(Math.random() * 100);
        const chance = Math.min(Math.max(percent, 1), MAX_PERCENT);
        const isWin = isHigher ? roll > (100 - chance) : roll < chance;
        const wonAmount = isWin ? calcPossibleWin() : 0;
        const delta = -amount + wonAmount;
        const newBalance = +(balance + delta).toFixed(2);
        setBalance(newBalance);
        setLastGames((prev) => [{ id: Date.now(), roll, isWin, wonAmount, amount }, ...prev].slice(0, 10));
        setHash(generateHash());
        setAnimClass(isWin ? "animate-win" : "animate-lose");
        setTimeout(() => setAnimClass(""), 600);

        // отправляем на сервер обновление
        if (tg && tg.initDataUnsafe?.user) {
          fetch(`${API_URL}/api/update_balance`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: tg.initDataUnsafe.user.id, delta }),
          }).then(r => r.json()).then(d => {
            if (d.balance !== undefined) setBalance(d.balance);
          });
        }
      }

      if (balance === null) return <div className="text-gray-600">Загрузка...</div>;

      return (
        <div className={`bg-white p-6 rounded-2xl shadow-md w-full ${animClass}`}>
          <header className="flex items-center justify-between mb-6">
            <h1 className="text-2xl font-bold text-blue-700">MELBET</h1>
            <div className="flex items-center gap-3">
              <span className="text-gray-600 text-sm">Баланс:</span>
              <div className="bg-gray-100 px-3 py-1 rounded font-semibold">{balance.toFixed(2)}</div>
            </div>
          </header>

          <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div>
              <label className="block text-sm text-gray-600 mb-1">Сумма</label>
              <input type="number" value={amount} onChange={e=>setAmount(+e.target.value)} className="w-full border rounded px-3 py-2"/>
            </div>
            <div>
              <label className="block text-sm text-gray-600 mb-1">Шанс</label>
              <input type="number" value={percent} onChange={e=>setPercent(+e.target.value)} className="w-full border rounded px-3 py-2"/>
            </div>
            <div className="text-center">
              <div className="text-lg text-blue-600 font-semibold mb-1">{calcPossibleWin().toFixed(2)}</div>
              <div className="text-sm text-gray-500 mb-2">Возможный выигрыш</div>
              <div className="flex justify-center gap-2">
                <button onClick={()=>play(false)} className="px-4 py-2 bg-gray-600 text-white rounded">Меньше</button>
                <button onClick={()=>play(true)} className="px-4 py-2 bg-blue-600 text-white rounded">Больше</button>
              </div>
            </div>
          </div>

          <div className="mt-6 text-sm text-gray-500">
            Hash: <code className="bg-gray-50 px-2 py-1 rounded">{hash}</code>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
<!-- <!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <title>MELBET</title>
</head>

<body class="bg-gray-100 p-4">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const tg = window.Telegram.WebApp;

function App() {
  const [balance, setBalance] = useState(null);
  const [amount, setAmount] = useState(10);
  const [percent, setPercent] = useState(50);

  const API_URL = "https://dfdb3c09-5d33-48ef-bee1-f90e7be06ae8-00-xcaxgzrezs81.janeway.replit.dev";

  useEffect(() => {
    tg.expand();

    if (!tg.initDataUnsafe?.user) {
      setBalance(0);
      return;
    }

    const id = tg.initDataUnsafe.user.id;

    fetch(${API_URL}/api/user/${id})
      .then(r => r.json())
      .then(data => setBalance(data.balance))
      .catch(() => setBalance(0));

  }, []);

  function calcWin() {
    return +(amount * (100 / percent)).toFixed(2);
  }

  function play(high) {
    if (balance < amount) return;

    const roll = Math.random() * 100;
    const win = high ? roll > (100 - percent) : roll < percent;

    const winAmount = win ? calcWin() : 0;
    const delta = winAmount - amount;

    const id = tg.initDataUnsafe.user.id;

    fetch(${API_URL}/api/update_balance, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ id, delta })
    })
      .then(r => r.json())
      .then(d => setBalance(d.balance));
  }

  if (balance === null) return <div>Загрузка...</div>;

  return (
    <div className="bg-white p-4 rounded-xl shadow-md">
      <h1 className="text-xl font-bold mb-4">MELBET</h1>

      <div className="mb-3">
        Баланс: <b>{balance.toFixed(2)} USDT</b>
      </div>

      <input type="number" value={amount}
             onChange={e => setAmount(+e.target.value)}
             className="border p-2 w-full mb-3"/>

      <input type="number" value={percent}
             onChange={e => setPercent(+e.target.value)}
             className="border p-2 w-full mb-3"/>

      <div className="text-sm text-gray-500 mb-2">Возможный выигрыш: {calcWin()} USDT</div>

      <button onClick={() => play(false)}
              className="bg-gray-700 text-white w-full p-2 rounded mb-2">Меньше</button>

      <button onClick={() => play(true)}
              className="bg-blue-600 text-white w-full p-2 rounded">Больше</button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html> -->
